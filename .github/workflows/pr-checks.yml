name: Pull Request Checks

on:
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened ]

jobs:
  pr-validation:
    name: Validate PR
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check PR title format
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          if [[ ! "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|perf|test|chore|ci|build)(\(.+\))?\:\ .+$ ]]; then
            echo "‚ùå PR title must follow Conventional Commits format"
            echo "Examples: feat: add new feature, fix(api): correct bug"
            exit 1
          fi
          echo "‚úÖ PR title format is valid"
      
      - name: Check PR size
        run: |
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          ADDITIONS=$(git diff --shortstat origin/${{ github.base_ref }}...HEAD | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+' || echo 0)
          DELETIONS=$(git diff --shortstat origin/${{ github.base_ref }}...HEAD | grep -oE '[0-9]+ deletion' | grep -oE '[0-9]+' || echo 0)
          
          echo "üìä PR Stats:"
          echo "- Files changed: $CHANGED_FILES"
          echo "- Insertions: $ADDITIONS"
          echo "- Deletions: $DELETIONS"
          
          if [ "$CHANGED_FILES" -gt 50 ]; then
            echo "‚ö†Ô∏è Warning: Large PR with $CHANGED_FILES files. Consider breaking it down."
          fi
      
      - name: Check for merge conflicts
        run: |
          git fetch origin ${{ github.base_ref }}
          if git merge-tree $(git merge-base HEAD origin/${{ github.base_ref }}) HEAD origin/${{ github.base_ref }} | grep -q "<<<<<"; then
            echo "‚ùå Merge conflicts detected"
            exit 1
          fi
          echo "‚úÖ No merge conflicts"
      
      - name: Check for TODO/FIXME
        run: |
          TODOS=$(git diff origin/${{ github.base_ref }}...HEAD | grep -E "^\+.*TODO|^\+.*FIXME" | wc -l)
          if [ "$TODOS" -gt 0 ]; then
            echo "‚ö†Ô∏è Found $TODOS new TODO/FIXME comments"
            git diff origin/${{ github.base_ref }}...HEAD | grep -E "^\+.*TODO|^\+.*FIXME"
          else
            echo "‚úÖ No new TODO/FIXME comments"
          fi

  all-checks:
    name: All Checks Pass
    runs-on: ubuntu-latest
    needs: [pr-validation]
    if: always()
    
    steps:
      - name: Check status
        run: |
          if [ "${{ needs.pr-validation.result }}" == "failure" ]; then
            echo "‚ùå PR validation failed"
            exit 1
          fi
          echo "‚úÖ All checks passed!"
