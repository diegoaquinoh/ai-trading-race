name: CI - Full Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch: # Allow manual trigger
  workflow_call:

jobs:
  backend:
    name: Backend CI
    uses: ./.github/workflows/backend.yml

  functions:
    name: Functions CI
    uses: ./.github/workflows/functions.yml

  frontend:
    name: Frontend CI
    uses: ./.github/workflows/frontend.yml

  ml-service:
    name: ML Service CI
    uses: ./.github/workflows/ml-service.yml

  integration-readiness:
    name: Integration Readiness Check
    runs-on: ubuntu-latest
    needs: [backend, functions, frontend, ml-service]

    steps:
      - name: Summary
        run: |
          echo "All CI checks passed!"
          echo ""
          echo "Backend build successful"
          echo "Functions build successful"
          echo "Frontend build successful"
          echo "ML Service build successful"
          echo ""
          echo "Deployment: pushes to main trigger .github/workflows/deploy.yml"
          echo ""
          echo "Required GitHub Secrets:"
          echo "  AZURE_CREDENTIALS                - Service principal JSON (az ad sp create-for-rbac)"
          echo "  AZURE_WEBAPP_PUBLISH_PROFILE      - az webapp deployment list-publishing-profiles"
          echo "  AZURE_FUNCTIONAPP_PUBLISH_PROFILE  - az functionapp deployment list-publishing-profiles"
          echo "  AZURE_STATIC_WEB_APPS_API_TOKEN   - az staticwebapp secrets list"
          echo "  GHCR_TOKEN                        - GitHub PAT with write:packages"
          echo "  SQL_ADMIN_PASSWORD                - Azure SQL admin password"
