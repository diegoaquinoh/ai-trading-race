# Critical Gaps Remediation Plan
**AI Trading Race Platform**  
**Date:** January 20, 2026  
**Priority:** CRITICAL - Must complete before production deployment

---

## Table of Contents

1. [Executive Summary](#executive-summary)
2. [Gap #1: Authentication & Authorization](#gap-1-authentication--authorization)
3. [Gap #2: Backup & Disaster Recovery](#gap-2-backup--disaster-recovery)
4. [Gap #3: Global Exception Handling](#gap-3-global-exception-handling)
5. [Gap #4: Observability & Monitoring](#gap-4-observability--monitoring)
6. [Gap #5: Rate Limiting](#gap-5-rate-limiting)
7. [Gap #6: Test Coverage](#gap-6-test-coverage)
8. [Implementation Timeline](#implementation-timeline)
9. [Resource Requirements](#resource-requirements)

---

## Executive Summary

### Current State Assessment

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CRITICAL GAPS OVERVIEW                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Gap                      â”‚ Severity   â”‚ Effort       â”‚ Risk if Unaddressed â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. No Authentication     â”‚ ğŸ”´ HIGH    â”‚ 2-3 days     â”‚ Unauthorized access â”‚
â”‚ 2. No Backup Strategy    â”‚ ğŸ”´ HIGH    â”‚ 1 day        â”‚ Data loss           â”‚
â”‚ 3. No Exception Handler  â”‚ ğŸŸ¡ MEDIUM  â”‚ 0.5 days     â”‚ Poor UX             â”‚
â”‚ 4. No Observability      â”‚ ğŸŸ¡ MEDIUM  â”‚ 3-4 days     â”‚ Blind operations    â”‚
â”‚ 5. No Rate Limiting      â”‚ ğŸŸ¡ MEDIUM  â”‚ 1 day        â”‚ DoS vulnerability   â”‚
â”‚ 6. Low Test Coverage     â”‚ ğŸŸ¡ MEDIUM  â”‚ 3-5 days     â”‚ Regression bugs     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                    Total Estimated Effort: 11-15 days
```

### Target Architecture After Remediation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SECURED & OBSERVABLE ARCHITECTURE                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚   Grafana   â”‚ â—„â”€â”€ Dashboards & Alerts
                                  â”‚  Dashboard  â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                        â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   React     â”‚   â”‚    JWT      â”‚  â”‚ Prometheus  â”‚   â”‚   Jaeger    â”‚     â”‚
â”‚  â”‚  Frontend   â”œâ”€â”€â–ºâ”‚   Auth      â”œâ”€â”€â–ºâ”‚   Metrics   â”‚   â”‚  Tracing    â”‚     â”‚
â”‚  â”‚             â”‚   â”‚  Middleware â”‚  â”‚             â”‚   â”‚             â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                           â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        â–¼                                            â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚                  RATE LIMITER (60 req/min)                  â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                        â”‚                                            â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚              GLOBAL EXCEPTION HANDLER                       â”‚   â”‚   â”‚
â”‚  â”‚  â”‚         (Consistent ProblemDetails responses)               â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                        â”‚                                            â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚                    API CONTROLLERS                          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    [Authorize] AgentsController, TradesController, etc.     â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚                     ASP.NET Core Web API                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      SQL SERVER 2022                                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚   Daily    â”‚  â”‚  Point-in  â”‚  â”‚   Azure    â”‚  â”‚  Restore   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚   Backup   â”‚  â”‚   -Time    â”‚  â”‚   Blob     â”‚  â”‚   Tested   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚            â”‚  â”‚  Recovery  â”‚  â”‚   Copy     â”‚  â”‚   Weekly   â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         TEST COVERAGE                               â”‚   â”‚
â”‚  â”‚         Unit Tests (80%) + E2E Tests + Performance Tests            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Gap #1: Authentication & Authorization

### Current State

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        âŒ CURRENT STATE (INSECURE)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   Anyone     â”‚         â”‚              ASP.NET Core API            â”‚
     â”‚  (Internet)  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                                          â”‚
     â”‚              â”‚         â”‚  POST /api/agents/{id}/run   âœ… ALLOWED  â”‚
     â”‚              â”‚         â”‚  POST /api/admin/ingest      âœ… ALLOWED  â”‚
     â”‚              â”‚         â”‚  GET  /api/leaderboard       âœ… ALLOWED  â”‚
     â”‚              â”‚         â”‚                                          â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚  âš ï¸ NO AUTHENTICATION REQUIRED           â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Target State

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        âœ… TARGET STATE (SECURE)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   Identity   â”‚                     â”‚         ASP.NET Core API         â”‚
     â”‚   Provider   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                  â”‚
     â”‚  (Auth0 /    â”‚  Validate JWT       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
     â”‚   Entra ID)  â”‚                     â”‚  â”‚   JWT Bearer Middleware    â”‚  â”‚
     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚  â”‚   (Validates token)        â”‚  â”‚
            â”‚                             â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
            â”‚ Issue JWT                   â”‚                â”‚                 â”‚
            â–¼                             â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚  â”‚   Role-Based Access        â”‚  â”‚
     â”‚    React     â”‚                     â”‚  â”‚                            â”‚  â”‚
     â”‚   Frontend   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  â”‚  Admin:  /api/admin/*     â”‚  â”‚
     â”‚              â”‚  Authorization:     â”‚  â”‚  User:   /api/agents/*    â”‚  â”‚
     â”‚              â”‚  Bearer <token>     â”‚  â”‚  Public: /api/leaderboard â”‚  â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Authentication Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        JWT AUTHENTICATION FLOW                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  React   â”‚         â”‚  Auth0 / â”‚         â”‚  ASP.NET â”‚         â”‚ Database â”‚
  â”‚ Frontend â”‚         â”‚ Entra ID â”‚         â”‚ Core API â”‚         â”‚          â”‚
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚  1. Login Request  â”‚                    â”‚                    â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚  2. Auth Challenge â”‚                    â”‚                    â”‚
       â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚  3. User Credentials                    â”‚                    â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚  4. JWT Token      â”‚                    â”‚                    â”‚
       â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚  5. API Request with Bearer Token       â”‚                    â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚  6. Validate Token â”‚                    â”‚
       â”‚                    â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚  7. Token Valid    â”‚                    â”‚
       â”‚                    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚  8. Query Data     â”‚
       â”‚                    â”‚                    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚  9. Data Response  â”‚
       â”‚                    â”‚                    â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚  10. API Response  â”‚                    â”‚                    â”‚
       â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
```

### Role-Based Access Control Matrix

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        RBAC PERMISSION MATRIX                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Endpoint                â”‚ Admin    â”‚ User     â”‚ ReadOnly â”‚ Anonymous       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ POST /api/admin/ingest  â”‚ âœ…       â”‚ âŒ       â”‚ âŒ       â”‚ âŒ              â”‚
â”‚ POST /api/agents/create â”‚ âœ…       â”‚ âŒ       â”‚ âŒ       â”‚ âŒ              â”‚
â”‚ POST /api/agents/{}/run â”‚ âœ…       â”‚ âœ…       â”‚ âŒ       â”‚ âŒ              â”‚
â”‚ GET  /api/agents        â”‚ âœ…       â”‚ âœ…       â”‚ âœ…       â”‚ âŒ              â”‚
â”‚ GET  /api/agents/{id}   â”‚ âœ…       â”‚ âœ…       â”‚ âœ…       â”‚ âŒ              â”‚
â”‚ GET  /api/leaderboard   â”‚ âœ…       â”‚ âœ…       â”‚ âœ…       â”‚ âœ…              â”‚
â”‚ GET  /api/market/candlesâ”‚ âœ…       â”‚ âœ…       â”‚ âœ…       â”‚ âœ…              â”‚
â”‚ GET  /health            â”‚ âœ…       â”‚ âœ…       â”‚ âœ…       â”‚ âœ…              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Implementation Plan

#### Phase 1: Install Required Packages

```bash
# Add NuGet packages to AiTradingRace.Web
dotnet add AiTradingRace.Web package Microsoft.AspNetCore.Authentication.JwtBearer
dotnet add AiTradingRace.Web package Microsoft.Identity.Web  # If using Entra ID
```

#### Phase 2: Configuration

**File: `AiTradingRace.Web/appsettings.json`**
```json
{
  "Authentication": {
    "Authority": "https://your-tenant.auth0.com/",
    "Audience": "https://api.ai-trading-race.com",
    "ValidIssuers": ["https://your-tenant.auth0.com/"],
    "RequireHttpsMetadata": true
  },
  "Authorization": {
    "Roles": {
      "Admin": "admin",
      "User": "user",
      "ReadOnly": "readonly"
    }
  }
}
```

#### Phase 3: Service Registration

**File: `AiTradingRace.Web/Extensions/AuthenticationExtensions.cs`**
```csharp
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.IdentityModel.Tokens;

namespace AiTradingRace.Web.Extensions;

public static class AuthenticationExtensions
{
    public static IServiceCollection AddJwtAuthentication(
        this IServiceCollection services,
        IConfiguration configuration)
    {
        var authSection = configuration.GetSection("Authentication");
        
        services.AddAuthentication(options =>
        {
            options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
            options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
        })
        .AddJwtBearer(options =>
        {
            options.Authority = authSection["Authority"];
            options.Audience = authSection["Audience"];
            options.RequireHttpsMetadata = 
                authSection.GetValue<bool>("RequireHttpsMetadata", true);
            
            options.TokenValidationParameters = new TokenValidationParameters
            {
                ValidateIssuer = true,
                ValidIssuers = authSection.GetSection("ValidIssuers").Get<string[]>(),
                ValidateAudience = true,
                ValidAudience = authSection["Audience"],
                ValidateLifetime = true,
                ClockSkew = TimeSpan.FromMinutes(5)
            };
            
            options.Events = new JwtBearerEvents
            {
                OnAuthenticationFailed = context =>
                {
                    var logger = context.HttpContext.RequestServices
                        .GetRequiredService<ILogger<Program>>();
                    logger.LogWarning("Authentication failed: {Error}", 
                        context.Exception.Message);
                    return Task.CompletedTask;
                },
                OnTokenValidated = context =>
                {
                    var logger = context.HttpContext.RequestServices
                        .GetRequiredService<ILogger<Program>>();
                    var userId = context.Principal?.Identity?.Name;
                    logger.LogDebug("Token validated for user: {UserId}", userId);
                    return Task.CompletedTask;
                }
            };
        });

        services.AddAuthorizationBuilder()
            .AddPolicy("AdminOnly", policy => 
                policy.RequireRole("admin"))
            .AddPolicy("UserOrAdmin", policy => 
                policy.RequireRole("admin", "user"))
            .AddPolicy("ReadAccess", policy => 
                policy.RequireRole("admin", "user", "readonly"));

        return services;
    }
}
```

#### Phase 4: Update Program.cs

**File: `AiTradingRace.Web/Program.cs`**
```csharp
using AiTradingRace.Web.Extensions;

var builder = WebApplication.CreateBuilder(args);

// ... existing services ...

// Add Authentication & Authorization
builder.Services.AddJwtAuthentication(builder.Configuration);

var app = builder.Build();

// ... existing middleware ...

// Add auth middleware (MUST be before UseAuthorization)
app.UseAuthentication();
app.UseAuthorization();

// ... existing endpoints ...
```

#### Phase 5: Protect Controllers

**File: `AiTradingRace.Web/Controllers/AgentsController.cs`**
```csharp
using Microsoft.AspNetCore.Authorization;

namespace AiTradingRace.Web.Controllers;

[ApiController]
[Route("api/[controller]")]
[Authorize] // Require authentication for all endpoints
public class AgentsController : ControllerBase
{
    [HttpGet]
    [Authorize(Policy = "ReadAccess")]
    public async Task<ActionResult<List<AgentDto>>> GetAgents() { ... }

    [HttpGet("{id:guid}")]
    [Authorize(Policy = "ReadAccess")]
    public async Task<ActionResult<AgentDto>> GetAgent(Guid id) { ... }

    [HttpPost("{id:guid}/run")]
    [Authorize(Policy = "UserOrAdmin")]
    public async Task<ActionResult<AgentRunResultDto>> RunAgent(Guid id) { ... }

    [HttpPost]
    [Authorize(Policy = "AdminOnly")]
    public async Task<ActionResult<AgentDto>> CreateAgent(...) { ... }
}

[ApiController]
[Route("api/admin")]
[Authorize(Policy = "AdminOnly")]
public class AdminController : ControllerBase
{
    [HttpPost("ingest")]
    public async Task<IActionResult> IngestAllAssets() { ... }

    [HttpPost("ingest/{symbol}")]
    public async Task<IActionResult> IngestAsset(string symbol) { ... }
}

[ApiController]
[Route("api/[controller]")]
public class LeaderboardController : ControllerBase
{
    [HttpGet]
    [AllowAnonymous] // Public access
    public async Task<ActionResult<List<LeaderboardEntryDto>>> GetLeaderboard() { ... }
}
```

#### Phase 6: Update React Frontend

**File: `ai-trading-race-web/src/services/auth.ts`**
```typescript
import { Auth0Client } from '@auth0/auth0-spa-js';

const auth0 = new Auth0Client({
  domain: import.meta.env.VITE_AUTH0_DOMAIN,
  clientId: import.meta.env.VITE_AUTH0_CLIENT_ID,
  authorizationParams: {
    redirect_uri: window.location.origin,
    audience: import.meta.env.VITE_AUTH0_AUDIENCE,
  },
});

export async function getAccessToken(): Promise<string> {
  return await auth0.getTokenSilently();
}

export async function login(): Promise<void> {
  await auth0.loginWithRedirect();
}

export async function logout(): Promise<void> {
  await auth0.logout({ logoutParams: { returnTo: window.location.origin } });
}
```

**File: `ai-trading-race-web/src/services/api.ts`**
```typescript
import axios from 'axios';
import { getAccessToken } from './auth';

const api = axios.create({
  baseURL: import.meta.env.VITE_API_URL,
});

api.interceptors.request.use(async (config) => {
  try {
    const token = await getAccessToken();
    config.headers.Authorization = `Bearer ${token}`;
  } catch {
    // User not logged in, continue without token for public endpoints
  }
  return config;
});

export default api;
```

### Testing Authentication

```bash
# Test unauthorized access (should return 401)
curl -X POST http://localhost:5000/api/agents/123/run
# Expected: 401 Unauthorized

# Test with valid token
curl -X POST http://localhost:5000/api/agents/123/run \
  -H "Authorization: Bearer <valid-jwt-token>"
# Expected: 200 OK or 404 if agent doesn't exist

# Test admin endpoint with user role (should return 403)
curl -X POST http://localhost:5000/api/admin/ingest \
  -H "Authorization: Bearer <user-role-token>"
# Expected: 403 Forbidden
```

### Estimated Effort: 2-3 days

| Task | Hours |
|------|-------|
| Package installation & configuration | 2 |
| Auth service implementation | 4 |
| Controller protection | 4 |
| React frontend integration | 6 |
| Testing & validation | 4 |
| Documentation | 2 |
| **Total** | **22 hours (â‰ˆ3 days)** |

---

## Gap #2: Backup & Disaster Recovery

### Current State

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        âŒ CURRENT STATE (NO BACKUPS)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                        SQL Server 2022                               â”‚
     â”‚                                                                      â”‚
     â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                     â”‚
     â”‚   â”‚   Data     â”‚  â”€â”€â”€â”€â”€â”€â–º NO BACKUP â”€â”€â”€â”€â”€â”€â–º ğŸ’€ DATA LOSS RISK       â”‚
     â”‚   â”‚  Volume    â”‚                                                     â”‚
     â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                     â”‚
     â”‚                                                                      â”‚
     â”‚   â€¢ No automated backups                                             â”‚
     â”‚   â€¢ No point-in-time recovery                                        â”‚
     â”‚   â€¢ No offsite storage                                               â”‚
     â”‚   â€¢ No backup testing                                                â”‚
     â”‚                                                                      â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Target State

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        âœ… TARGET STATE (FULL DR)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                        SQL Server 2022                               â”‚
     â”‚                                                                      â”‚
     â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
     â”‚   â”‚    Data    â”‚     â”‚   Daily    â”‚     â”‚  Transactionâ”‚              â”‚
     â”‚   â”‚   Volume   â”‚â”€â”€â”€â”€â–ºâ”‚   Full     â”‚â”€â”€â”€â”€â–ºâ”‚    Log      â”‚              â”‚
     â”‚   â”‚            â”‚     â”‚   Backup   â”‚     â”‚   Backups   â”‚              â”‚
     â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜              â”‚
     â”‚                            â”‚                   â”‚                     â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚                   â”‚
                                  â–¼                   â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                        Backup Storage                                â”‚
     â”‚                                                                      â”‚
     â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
     â”‚   â”‚                    LOCAL BACKUPS                           â”‚    â”‚
     â”‚   â”‚   /backups/                                                â”‚    â”‚
     â”‚   â”‚   â”œâ”€â”€ daily/                                               â”‚    â”‚
     â”‚   â”‚   â”‚   â”œâ”€â”€ AiTradingRace_20260120_020000.bak               â”‚    â”‚
     â”‚   â”‚   â”‚   â”œâ”€â”€ AiTradingRace_20260119_020000.bak               â”‚    â”‚
     â”‚   â”‚   â”‚   â””â”€â”€ ... (7 days retention)                          â”‚    â”‚
     â”‚   â”‚   â””â”€â”€ logs/                                                â”‚    â”‚
     â”‚   â”‚       â”œâ”€â”€ AiTradingRace_20260120_*.trn                    â”‚    â”‚
     â”‚   â”‚       â””â”€â”€ ... (24 hours retention)                        â”‚    â”‚
     â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
     â”‚                            â”‚                                         â”‚
     â”‚                            â–¼                                         â”‚
     â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
     â”‚   â”‚                   OFFSITE BACKUP (Azure Blob)              â”‚    â”‚
     â”‚   â”‚   â€¢ Geo-redundant storage (GRS)                            â”‚    â”‚
     â”‚   â”‚   â€¢ 30-day retention                                       â”‚    â”‚
     â”‚   â”‚   â€¢ Encrypted at rest                                      â”‚    â”‚
     â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
     â”‚                                                                      â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Backup Strategy Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        BACKUP SCHEDULE & RETENTION                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  TIME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º

  â”‚ 00:00 â”‚ 02:00 â”‚ 04:00 â”‚ 06:00 â”‚ 08:00 â”‚ 10:00 â”‚ 12:00 â”‚ ... â”‚ 22:00 â”‚
  â”‚       â”‚   â”‚   â”‚       â”‚       â”‚       â”‚       â”‚       â”‚       â”‚       â”‚
  â”‚       â”‚   â–¼   â”‚       â”‚       â”‚       â”‚       â”‚       â”‚       â”‚       â”‚
  â”‚       â”‚ FULL  â”‚       â”‚       â”‚       â”‚       â”‚       â”‚       â”‚       â”‚
  â”‚       â”‚ BACKUPâ”‚       â”‚       â”‚       â”‚       â”‚       â”‚       â”‚       â”‚
  â”‚       â”‚       â”‚       â”‚       â”‚       â”‚       â”‚       â”‚       â”‚       â”‚
  â”‚   â–¼   â”‚       â”‚   â–¼   â”‚   â–¼   â”‚   â–¼   â”‚   â–¼   â”‚   â–¼   â”‚   â–¼   â”‚   â–¼   â”‚
  â”‚  LOG  â”‚       â”‚  LOG  â”‚  LOG  â”‚  LOG  â”‚  LOG  â”‚  LOG  â”‚  LOG  â”‚  LOG  â”‚
  â”‚       â”‚       â”‚       â”‚       â”‚       â”‚       â”‚       â”‚       â”‚       â”‚

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ RETENTION POLICY                                                        â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ Full Backups    â”‚ 7 days local + 30 days offsite (Azure Blob)          â”‚
  â”‚ Log Backups     â”‚ 24 hours local (enables point-in-time recovery)      â”‚
  â”‚ Offsite Sync    â”‚ Daily at 04:00 UTC                                   â”‚
  â”‚ Backup Test     â”‚ Weekly (automated restore to test database)          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Recovery Time & Point Objectives

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        RTO / RPO TARGETS                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ DISASTER OCCURS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
                           â”‚
                           â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                        â”‚                                                â”‚
  â”‚   RPO (Recovery Point Objective)                                        â”‚
  â”‚   â—„â”€â”€â”€â”€â”€â”€â”€ MAX 2 HOURS â”€â”€â”€â”€â”€â”€â”€â”€â–º                                       â”‚
  â”‚   â”‚                    â”‚                                                â”‚
  â”‚   â”‚   Last Log Backup  â”‚  Disaster                                      â”‚
  â”‚   â”‚        â–¼           â”‚     â–¼                                          â”‚
  â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
  â”‚                        â”‚                                                â”‚
  â”‚   RTO (Recovery Time Objective)                                         â”‚
  â”‚                        â”‚â—„â”€â”€â”€â”€ MAX 1 HOUR â”€â”€â”€â”€â–ºâ”‚                        â”‚
  â”‚                        â”‚                      â”‚                         â”‚
  â”‚   Disaster             â”‚  Service Restored    â”‚                         â”‚
  â”‚      â–¼                 â”‚         â–¼            â”‚                         â”‚
  â”‚   â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                        â”‚                      â”‚                         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚                      â”‚
                           â–¼                      â–¼
                    Data Loss Window       Downtime Window
                     (Max 2 hours)          (Max 1 hour)
```

### Implementation Plan

#### Phase 1: Create Backup Directory Structure

```bash
# Create backup directories on host
mkdir -p /backups/ai-trading-race/{daily,logs,test-restore}
chmod 700 /backups/ai-trading-race
```

#### Phase 2: Update Docker Compose

**File: `docker-compose.yml`**
```yaml
services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: ai-trading-sqlserver
    ports:
      - "1433:1433"
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=${SA_PASSWORD:-$SA_PASSWORD}
      - MSSQL_PID=Developer
      - MSSQL_AGENT_ENABLED=true  # Enable SQL Agent for scheduled jobs
    volumes:
      - sqlserver-data:/var/opt/mssql
      - ./backups:/var/opt/mssql/backup  # Mount backup directory
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P '${SA_PASSWORD}' -C -Q 'SELECT 1' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - ai-trading-network
```

#### Phase 3: Backup Scripts

**File: `scripts/backup-database.sh`**
```bash
#!/bin/bash
#
# AI Trading Race - Database Backup Script
# Performs full backup with transaction log backups
#

set -euo pipefail

# Configuration
CONTAINER_NAME="${CONTAINER_NAME:-ai-trading-sqlserver}"
DB_NAME="${DB_NAME:-AiTradingRace}"
SA_PASSWORD="${SA_PASSWORD:-$SA_PASSWORD}"
BACKUP_DIR="/var/opt/mssql/backup"
LOCAL_BACKUP_DIR="${LOCAL_BACKUP_DIR:-./backups}"
RETENTION_DAYS="${RETENTION_DAYS:-7}"
LOG_RETENTION_HOURS="${LOG_RETENTION_HOURS:-24}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Logging
log() {
    echo -e "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

log_success() {
    log "${GREEN}âœ… $1${NC}"
}

log_warn() {
    log "${YELLOW}âš ï¸  $1${NC}"
}

log_error() {
    log "${RED}âŒ $1${NC}"
}

# Generate timestamp
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${DB_NAME}_${TIMESTAMP}.bak"
LOG_BACKUP_FILE="${DB_NAME}_${TIMESTAMP}.trn"

# Determine backup type (full or log)
BACKUP_TYPE="${1:-full}"

log "Starting $BACKUP_TYPE backup for database: $DB_NAME"

# Check if container is running
if ! docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
    log_error "Container $CONTAINER_NAME is not running"
    exit 1
fi

# Create backup directory inside container if needed
docker exec $CONTAINER_NAME mkdir -p $BACKUP_DIR/{daily,logs}

if [ "$BACKUP_TYPE" = "full" ]; then
    # Full database backup
    log "Performing full backup..."
    
    docker exec $CONTAINER_NAME /opt/mssql-tools18/bin/sqlcmd \
        -S localhost \
        -U sa \
        -P "$SA_PASSWORD" \
        -C \
        -Q "
        BACKUP DATABASE [$DB_NAME]
        TO DISK = '$BACKUP_DIR/daily/$BACKUP_FILE'
        WITH FORMAT, INIT,
        NAME = '$DB_NAME Full Backup',
        COMPRESSION,
        STATS = 10;
        "
    
    if [ $? -eq 0 ]; then
        log_success "Full backup completed: $BACKUP_FILE"
        
        # Copy to local directory
        mkdir -p "$LOCAL_BACKUP_DIR/daily"
        docker cp "$CONTAINER_NAME:$BACKUP_DIR/daily/$BACKUP_FILE" \
            "$LOCAL_BACKUP_DIR/daily/"
        
        log_success "Backup copied to local: $LOCAL_BACKUP_DIR/daily/$BACKUP_FILE"
    else
        log_error "Full backup failed!"
        exit 1
    fi
    
elif [ "$BACKUP_TYPE" = "log" ]; then
    # Transaction log backup
    log "Performing transaction log backup..."
    
    docker exec $CONTAINER_NAME /opt/mssql-tools18/bin/sqlcmd \
        -S localhost \
        -U sa \
        -P "$SA_PASSWORD" \
        -C \
        -Q "
        BACKUP LOG [$DB_NAME]
        TO DISK = '$BACKUP_DIR/logs/$LOG_BACKUP_FILE'
        WITH FORMAT, INIT,
        NAME = '$DB_NAME Log Backup',
        COMPRESSION,
        STATS = 10;
        "
    
    if [ $? -eq 0 ]; then
        log_success "Log backup completed: $LOG_BACKUP_FILE"
        
        # Copy to local directory
        mkdir -p "$LOCAL_BACKUP_DIR/logs"
        docker cp "$CONTAINER_NAME:$BACKUP_DIR/logs/$LOG_BACKUP_FILE" \
            "$LOCAL_BACKUP_DIR/logs/"
        
        log_success "Log backup copied to local: $LOCAL_BACKUP_DIR/logs/$LOG_BACKUP_FILE"
    else
        log_error "Log backup failed!"
        exit 1
    fi
fi

# Cleanup old backups
log "Cleaning up old backups (retention: $RETENTION_DAYS days for full, $LOG_RETENTION_HOURS hours for logs)..."

# Remove old full backups
find "$LOCAL_BACKUP_DIR/daily" -name "*.bak" -type f -mtime +$RETENTION_DAYS -delete 2>/dev/null || true

# Remove old log backups (convert hours to minutes for find)
LOG_RETENTION_MINUTES=$((LOG_RETENTION_HOURS * 60))
find "$LOCAL_BACKUP_DIR/logs" -name "*.trn" -type f -mmin +$LOG_RETENTION_MINUTES -delete 2>/dev/null || true

# Also cleanup inside container
docker exec $CONTAINER_NAME find $BACKUP_DIR/daily -name "*.bak" -type f -mtime +$RETENTION_DAYS -delete 2>/dev/null || true
docker exec $CONTAINER_NAME find $BACKUP_DIR/logs -name "*.trn" -type f -mmin +$LOG_RETENTION_MINUTES -delete 2>/dev/null || true

log_success "Cleanup completed"

# Print backup summary
log "ğŸ“Š Backup Summary:"
echo "   Database: $DB_NAME"
echo "   Type: $BACKUP_TYPE"
echo "   File: $([ "$BACKUP_TYPE" = "full" ] && echo $BACKUP_FILE || echo $LOG_BACKUP_FILE)"
echo "   Location: $LOCAL_BACKUP_DIR"
echo "   Timestamp: $(date)"

# Verify backup
log "Verifying backup..."
docker exec $CONTAINER_NAME /opt/mssql-tools18/bin/sqlcmd \
    -S localhost \
    -U sa \
    -P "$SA_PASSWORD" \
    -C \
    -Q "RESTORE VERIFYONLY FROM DISK = '$BACKUP_DIR/$([ "$BACKUP_TYPE" = "full" ] && echo "daily/$BACKUP_FILE" || echo "logs/$LOG_BACKUP_FILE")'"

if [ $? -eq 0 ]; then
    log_success "Backup verification passed âœ“"
else
    log_error "Backup verification failed!"
    exit 1
fi

log_success "Backup process completed successfully!"
```

#### Phase 4: Restore Script

**File: `scripts/restore-database.sh`**
```bash
#!/bin/bash
#
# AI Trading Race - Database Restore Script
# Restores from full backup with optional point-in-time recovery
#

set -euo pipefail

# Configuration
CONTAINER_NAME="${CONTAINER_NAME:-ai-trading-sqlserver}"
DB_NAME="${DB_NAME:-AiTradingRace}"
SA_PASSWORD="${SA_PASSWORD:-$SA_PASSWORD}"
BACKUP_DIR="/var/opt/mssql/backup"
LOCAL_BACKUP_DIR="${LOCAL_BACKUP_DIR:-./backups}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log() {
    echo -e "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

log_success() {
    log "${GREEN}âœ… $1${NC}"
}

log_warn() {
    log "${YELLOW}âš ï¸  $1${NC}"
}

log_error() {
    log "${RED}âŒ $1${NC}"
}

# Usage
usage() {
    echo "Usage: $0 [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  --backup-file FILE    Full backup file to restore (required)"
    echo "  --target-db NAME      Target database name (default: AiTradingRace_Restored)"
    echo "  --point-in-time TIME  Point-in-time recovery (format: YYYY-MM-DD HH:MM:SS)"
    echo "  --log-files FILES     Comma-separated list of log backup files"
    echo "  --replace             Replace existing database (DANGER!)"
    echo "  --help                Show this help message"
    echo ""
    echo "Examples:"
    echo "  # Restore to test database"
    echo "  $0 --backup-file AiTradingRace_20260120_020000.bak --target-db AiTradingRace_Test"
    echo ""
    echo "  # Point-in-time recovery"
    echo "  $0 --backup-file AiTradingRace_20260120_020000.bak \\"
    echo "     --log-files log1.trn,log2.trn \\"
    echo "     --point-in-time '2026-01-20 10:30:00'"
}

# Parse arguments
BACKUP_FILE=""
TARGET_DB="AiTradingRace_Restored"
POINT_IN_TIME=""
LOG_FILES=""
REPLACE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --backup-file)
            BACKUP_FILE="$2"
            shift 2
            ;;
        --target-db)
            TARGET_DB="$2"
            shift 2
            ;;
        --point-in-time)
            POINT_IN_TIME="$2"
            shift 2
            ;;
        --log-files)
            LOG_FILES="$2"
            shift 2
            ;;
        --replace)
            REPLACE=true
            shift
            ;;
        --help)
            usage
            exit 0
            ;;
        *)
            log_error "Unknown option: $1"
            usage
            exit 1
            ;;
    esac
done

# Validate required arguments
if [ -z "$BACKUP_FILE" ]; then
    log_error "Backup file is required"
    usage
    exit 1
fi

log "Starting database restore..."
log "  Backup file: $BACKUP_FILE"
log "  Target database: $TARGET_DB"
[ -n "$POINT_IN_TIME" ] && log "  Point-in-time: $POINT_IN_TIME"
[ -n "$LOG_FILES" ] && log "  Log files: $LOG_FILES"

# Confirmation for destructive operations
if [ "$REPLACE" = true ] && [ "$TARGET_DB" = "$DB_NAME" ]; then
    log_warn "âš ï¸  WARNING: You are about to REPLACE the production database!"
    read -p "Are you sure? Type 'YES' to confirm: " confirm
    if [ "$confirm" != "YES" ]; then
        log "Restore cancelled."
        exit 0
    fi
fi

# Copy backup file to container if needed
if [ ! -f "$LOCAL_BACKUP_DIR/daily/$BACKUP_FILE" ]; then
    log_error "Backup file not found: $LOCAL_BACKUP_DIR/daily/$BACKUP_FILE"
    exit 1
fi

docker cp "$LOCAL_BACKUP_DIR/daily/$BACKUP_FILE" \
    "$CONTAINER_NAME:$BACKUP_DIR/daily/"

# Generate restore command
RESTORE_CMD="
USE master;
GO

-- Drop existing connections to target database
IF EXISTS (SELECT 1 FROM sys.databases WHERE name = '$TARGET_DB')
BEGIN
    ALTER DATABASE [$TARGET_DB] SET SINGLE_USER WITH ROLLBACK IMMEDIATE;
END
GO

-- Restore full backup
RESTORE DATABASE [$TARGET_DB]
FROM DISK = '$BACKUP_DIR/daily/$BACKUP_FILE'
WITH
    MOVE '${DB_NAME}' TO '/var/opt/mssql/data/${TARGET_DB}.mdf',
    MOVE '${DB_NAME}_log' TO '/var/opt/mssql/data/${TARGET_DB}_log.ldf',
"

if [ -n "$LOG_FILES" ]; then
    RESTORE_CMD+="    NORECOVERY,
    REPLACE,
    STATS = 10;
GO
"
    # Apply log backups
    IFS=',' read -ra LOGS <<< "$LOG_FILES"
    for log_file in "${LOGS[@]}"; do
        # Copy log file to container
        docker cp "$LOCAL_BACKUP_DIR/logs/$log_file" \
            "$CONTAINER_NAME:$BACKUP_DIR/logs/"
        
        RESTORE_CMD+="
RESTORE LOG [$TARGET_DB]
FROM DISK = '$BACKUP_DIR/logs/$log_file'
WITH NORECOVERY, STATS = 10;
GO
"
    done
    
    # Final recovery
    if [ -n "$POINT_IN_TIME" ]; then
        RESTORE_CMD+="
RESTORE LOG [$TARGET_DB]
FROM DISK = '$BACKUP_DIR/logs/${LOGS[-1]}'
WITH RECOVERY, STOPAT = '$POINT_IN_TIME';
GO
"
    else
        RESTORE_CMD+="
RESTORE DATABASE [$TARGET_DB] WITH RECOVERY;
GO
"
    fi
else
    RESTORE_CMD+="    RECOVERY,
    REPLACE,
    STATS = 10;
GO
"
fi

# Execute restore
log "Executing restore..."
echo "$RESTORE_CMD" | docker exec -i $CONTAINER_NAME /opt/mssql-tools18/bin/sqlcmd \
    -S localhost \
    -U sa \
    -P "$SA_PASSWORD" \
    -C

if [ $? -eq 0 ]; then
    log_success "Database restored successfully to: $TARGET_DB"
    
    # Verify restore
    log "Verifying restored database..."
    docker exec $CONTAINER_NAME /opt/mssql-tools18/bin/sqlcmd \
        -S localhost \
        -U sa \
        -P "$SA_PASSWORD" \
        -C \
        -Q "SELECT COUNT(*) AS AgentCount FROM [$TARGET_DB].dbo.Agents"
    
    log_success "Restore verification completed!"
else
    log_error "Restore failed!"
    exit 1
fi
```

#### Phase 5: Cron Schedule Setup

**File: `scripts/setup-backup-cron.sh`**
```bash
#!/bin/bash
#
# Setup automated backup schedule via cron
#

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Create cron entries
cat << EOF | crontab -
# AI Trading Race - Database Backup Schedule
# Full backup daily at 2:00 AM
0 2 * * * $SCRIPT_DIR/backup-database.sh full >> /var/log/ai-trading-backup.log 2>&1

# Transaction log backup every 2 hours
0 */2 * * * $SCRIPT_DIR/backup-database.sh log >> /var/log/ai-trading-backup.log 2>&1

# Weekly backup verification (restore to test DB)
0 4 * * 0 $SCRIPT_DIR/test-backup-restore.sh >> /var/log/ai-trading-backup.log 2>&1
EOF

echo "Backup schedule configured:"
crontab -l
```

#### Phase 6: Offsite Backup (Azure Blob)

**File: `scripts/sync-to-azure.sh`**
```bash
#!/bin/bash
#
# Sync backups to Azure Blob Storage
#

set -euo pipefail

# Configuration
AZURE_STORAGE_ACCOUNT="${AZURE_STORAGE_ACCOUNT:-aitradingbackups}"
AZURE_CONTAINER="${AZURE_CONTAINER:-database-backups}"
LOCAL_BACKUP_DIR="${LOCAL_BACKUP_DIR:-./backups}"

# Install Azure CLI if not present
if ! command -v az &> /dev/null; then
    echo "Installing Azure CLI..."
    brew install azure-cli
fi

# Login (use managed identity in production)
# az login

# Sync full backups
echo "Syncing full backups to Azure Blob..."
az storage blob upload-batch \
    --account-name "$AZURE_STORAGE_ACCOUNT" \
    --destination "$AZURE_CONTAINER/daily" \
    --source "$LOCAL_BACKUP_DIR/daily" \
    --pattern "*.bak" \
    --overwrite

# Sync log backups
echo "Syncing log backups to Azure Blob..."
az storage blob upload-batch \
    --account-name "$AZURE_STORAGE_ACCOUNT" \
    --destination "$AZURE_CONTAINER/logs" \
    --source "$LOCAL_BACKUP_DIR/logs" \
    --pattern "*.trn" \
    --overwrite

# Apply Azure lifecycle policy (30-day retention)
az storage blob service-properties update \
    --account-name "$AZURE_STORAGE_ACCOUNT" \
    --static-website false

echo "Offsite sync completed!"
```

### Disaster Recovery Runbook

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        DISASTER RECOVERY RUNBOOK                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  SCENARIO 1: Database Corruption
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  1. Stop all services accessing the database
  2. Identify the last known good state
  3. Run: ./scripts/restore-database.sh --backup-file <latest.bak> --replace
  4. Verify data integrity
  5. Resume services

  SCENARIO 2: Complete Server Failure
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  1. Provision new SQL Server container
  2. Download backups from Azure Blob
  3. Run: ./scripts/restore-database.sh --backup-file <latest.bak>
  4. Apply log backups for point-in-time recovery
  5. Update connection strings
  6. Resume services

  SCENARIO 3: Point-in-Time Recovery (Accidental Data Deletion)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  1. Identify the exact time of the incident
  2. Collect required backup files:
     - Full backup before the incident
     - All log backups up to the incident time
  3. Run: ./scripts/restore-database.sh \
       --backup-file <full.bak> \
       --log-files log1.trn,log2.trn \
       --point-in-time "YYYY-MM-DD HH:MM:SS" \
       --target-db AiTradingRace_Recovered
  4. Verify recovered data
  5. Merge recovered data with production (if needed)
```

### Estimated Effort: 1 day

| Task | Hours |
|------|-------|
| Docker Compose updates | 1 |
| Backup script creation | 2 |
| Restore script creation | 2 |
| Cron setup & testing | 1 |
| Azure Blob integration | 1 |
| Documentation & runbook | 1 |
| **Total** | **8 hours (â‰ˆ1 day)** |

---

## Gap #3: Global Exception Handling

### Current State

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        âŒ CURRENT STATE (INCONSISTENT)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Request â”€â”€â–º Controller â”€â”€â–º Exception Thrown!
                                    â”‚
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚    No Centralized Handler â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                     â”‚                     â”‚
              â–¼                     â–¼                     â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   500     â”‚         â”‚   HTML    â”‚         â”‚  Generic  â”‚
       â”‚ Internal  â”‚         â”‚  Error    â”‚         â”‚  Message  â”‚
       â”‚  Error    â”‚         â”‚  Page     â”‚         â”‚           â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       
       âš ï¸ Different formats, no correlation IDs, no structured data
```

### Target State

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        âœ… TARGET STATE (CONSISTENT)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Request â”€â”€â–º Controller â”€â”€â–º Exception Thrown!
                                    â”‚
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚  Global Exception Handler â”‚
                      â”‚    (IExceptionHandler)    â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚    Unified Response       â”‚
                      â”‚                           â”‚
                      â”‚  {                        â”‚
                      â”‚    "type": "...",         â”‚
                      â”‚    "title": "...",        â”‚
                      â”‚    "status": 500,         â”‚
                      â”‚    "detail": "...",       â”‚
                      â”‚    "traceId": "abc-123",  â”‚
                      â”‚    "errors": {...}        â”‚
                      â”‚  }                        â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚   Structured Logging      â”‚
                      â”‚   with Correlation ID     â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Error Response Standard (RFC 7807)

```json
{
  "type": "https://api.ai-trading-race.com/errors/validation-error",
  "title": "Validation Error",
  "status": 400,
  "detail": "One or more validation errors occurred.",
  "instance": "/api/agents/run",
  "traceId": "00-abc123-def456-00",
  "timestamp": "2026-01-20T10:30:00Z",
  "errors": {
    "agentId": ["Agent ID must be a valid GUID"],
    "quantity": ["Quantity must be greater than 0"]
  }
}
```

### Implementation Plan

#### Phase 1: Create Exception Types

**File: `AiTradingRace.Application/Common/Exceptions/AppException.cs`**
```csharp
namespace AiTradingRace.Application.Common.Exceptions;

/// <summary>
/// Base exception for all application-specific exceptions.
/// </summary>
public abstract class AppException : Exception
{
    public abstract int StatusCode { get; }
    public abstract string ErrorType { get; }
    
    protected AppException(string message) : base(message) { }
    protected AppException(string message, Exception inner) : base(message, inner) { }
}

/// <summary>
/// Thrown when a requested resource is not found.
/// </summary>
public class NotFoundException : AppException
{
    public override int StatusCode => 404;
    public override string ErrorType => "https://api.ai-trading-race.com/errors/not-found";
    
    public string ResourceType { get; }
    public string ResourceId { get; }
    
    public NotFoundException(string resourceType, string resourceId)
        : base($"{resourceType} with ID '{resourceId}' was not found.")
    {
        ResourceType = resourceType;
        ResourceId = resourceId;
    }
}

/// <summary>
/// Thrown when validation fails.
/// </summary>
public class ValidationException : AppException
{
    public override int StatusCode => 400;
    public override string ErrorType => "https://api.ai-trading-race.com/errors/validation-error";
    
    public IDictionary<string, string[]> Errors { get; }
    
    public ValidationException(IDictionary<string, string[]> errors)
        : base("One or more validation errors occurred.")
    {
        Errors = errors;
    }
    
    public ValidationException(string field, string message)
        : this(new Dictionary<string, string[]> { { field, new[] { message } } })
    { }
}

/// <summary>
/// Thrown when a business rule is violated.
/// </summary>
public class BusinessRuleException : AppException
{
    public override int StatusCode => 422;
    public override string ErrorType => "https://api.ai-trading-race.com/errors/business-rule-violation";
    
    public string RuleCode { get; }
    
    public BusinessRuleException(string ruleCode, string message)
        : base(message)
    {
        RuleCode = ruleCode;
    }
}

/// <summary>
/// Thrown when an external service fails.
/// </summary>
public class ExternalServiceException : AppException
{
    public override int StatusCode => 502;
    public override string ErrorType => "https://api.ai-trading-race.com/errors/external-service-error";
    
    public string ServiceName { get; }
    
    public ExternalServiceException(string serviceName, string message, Exception? inner = null)
        : base($"External service '{serviceName}' failed: {message}", inner!)
    {
        ServiceName = serviceName;
    }
}

/// <summary>
/// Thrown when rate limit is exceeded.
/// </summary>
public class RateLimitException : AppException
{
    public override int StatusCode => 429;
    public override string ErrorType => "https://api.ai-trading-race.com/errors/rate-limit-exceeded";
    
    public TimeSpan RetryAfter { get; }
    
    public RateLimitException(TimeSpan retryAfter)
        : base($"Rate limit exceeded. Retry after {retryAfter.TotalSeconds} seconds.")
    {
        RetryAfter = retryAfter;
    }
}
```

#### Phase 2: Create Global Exception Handler

**File: `AiTradingRace.Web/Middleware/GlobalExceptionHandler.cs`**
```csharp
using System.Diagnostics;
using AiTradingRace.Application.Common.Exceptions;
using Microsoft.AspNetCore.Diagnostics;
using Microsoft.AspNetCore.Mvc;

namespace AiTradingRace.Web.Middleware;

/// <summary>
/// Global exception handler that converts all exceptions to RFC 7807 ProblemDetails.
/// </summary>
public class GlobalExceptionHandler : IExceptionHandler
{
    private readonly ILogger<GlobalExceptionHandler> _logger;
    private readonly IHostEnvironment _env;

    public GlobalExceptionHandler(
        ILogger<GlobalExceptionHandler> logger,
        IHostEnvironment env)
    {
        _logger = logger;
        _env = env;
    }

    public async ValueTask<bool> TryHandleAsync(
        HttpContext httpContext,
        Exception exception,
        CancellationToken cancellationToken)
    {
        var traceId = Activity.Current?.Id ?? httpContext.TraceIdentifier;
        
        // Log the exception
        _logger.LogError(
            exception,
            "Unhandled exception occurred. TraceId: {TraceId}, Path: {Path}, Method: {Method}",
            traceId,
            httpContext.Request.Path,
            httpContext.Request.Method);

        // Create ProblemDetails based on exception type
        var problemDetails = CreateProblemDetails(exception, traceId);
        
        // Set response
        httpContext.Response.StatusCode = problemDetails.Status ?? 500;
        httpContext.Response.ContentType = "application/problem+json";
        
        await httpContext.Response.WriteAsJsonAsync(problemDetails, cancellationToken);
        
        return true; // Exception was handled
    }

    private ProblemDetails CreateProblemDetails(Exception exception, string traceId)
    {
        return exception switch
        {
            NotFoundException notFoundEx => new ProblemDetails
            {
                Type = notFoundEx.ErrorType,
                Title = "Resource Not Found",
                Status = notFoundEx.StatusCode,
                Detail = notFoundEx.Message,
                Extensions =
                {
                    ["traceId"] = traceId,
                    ["timestamp"] = DateTimeOffset.UtcNow,
                    ["resourceType"] = notFoundEx.ResourceType,
                    ["resourceId"] = notFoundEx.ResourceId
                }
            },
            
            ValidationException validationEx => new ProblemDetails
            {
                Type = validationEx.ErrorType,
                Title = "Validation Error",
                Status = validationEx.StatusCode,
                Detail = validationEx.Message,
                Extensions =
                {
                    ["traceId"] = traceId,
                    ["timestamp"] = DateTimeOffset.UtcNow,
                    ["errors"] = validationEx.Errors
                }
            },
            
            BusinessRuleException businessEx => new ProblemDetails
            {
                Type = businessEx.ErrorType,
                Title = "Business Rule Violation",
                Status = businessEx.StatusCode,
                Detail = businessEx.Message,
                Extensions =
                {
                    ["traceId"] = traceId,
                    ["timestamp"] = DateTimeOffset.UtcNow,
                    ["ruleCode"] = businessEx.RuleCode
                }
            },
            
            ExternalServiceException externalEx => new ProblemDetails
            {
                Type = externalEx.ErrorType,
                Title = "External Service Error",
                Status = externalEx.StatusCode,
                Detail = _env.IsDevelopment() ? externalEx.Message : "An external service is temporarily unavailable.",
                Extensions =
                {
                    ["traceId"] = traceId,
                    ["timestamp"] = DateTimeOffset.UtcNow,
                    ["serviceName"] = externalEx.ServiceName
                }
            },
            
            RateLimitException rateLimitEx => new ProblemDetails
            {
                Type = rateLimitEx.ErrorType,
                Title = "Rate Limit Exceeded",
                Status = rateLimitEx.StatusCode,
                Detail = rateLimitEx.Message,
                Extensions =
                {
                    ["traceId"] = traceId,
                    ["timestamp"] = DateTimeOffset.UtcNow,
                    ["retryAfterSeconds"] = rateLimitEx.RetryAfter.TotalSeconds
                }
            },
            
            UnauthorizedAccessException => new ProblemDetails
            {
                Type = "https://api.ai-trading-race.com/errors/unauthorized",
                Title = "Unauthorized",
                Status = 401,
                Detail = "You are not authorized to access this resource.",
                Extensions =
                {
                    ["traceId"] = traceId,
                    ["timestamp"] = DateTimeOffset.UtcNow
                }
            },
            
            OperationCanceledException => new ProblemDetails
            {
                Type = "https://api.ai-trading-race.com/errors/request-cancelled",
                Title = "Request Cancelled",
                Status = 499, // Client Closed Request
                Detail = "The request was cancelled by the client.",
                Extensions =
                {
                    ["traceId"] = traceId,
                    ["timestamp"] = DateTimeOffset.UtcNow
                }
            },
            
            // Default: Internal Server Error
            _ => new ProblemDetails
            {
                Type = "https://api.ai-trading-race.com/errors/internal-server-error",
                Title = "Internal Server Error",
                Status = 500,
                Detail = _env.IsDevelopment() 
                    ? exception.ToString() 
                    : "An unexpected error occurred. Please try again later.",
                Extensions =
                {
                    ["traceId"] = traceId,
                    ["timestamp"] = DateTimeOffset.UtcNow
                }
            }
        };
    }
}
```

#### Phase 3: Update Program.cs

**File: `AiTradingRace.Web/Program.cs`**
```csharp
using AiTradingRace.Web.Middleware;

var builder = WebApplication.CreateBuilder(args);

// ... existing services ...

// Add exception handler
builder.Services.AddExceptionHandler<GlobalExceptionHandler>();
builder.Services.AddProblemDetails();

var app = builder.Build();

// Add exception handling middleware (MUST be first)
app.UseExceptionHandler();

// ... rest of middleware ...
```

#### Phase 4: Update Controllers to Use Custom Exceptions

**File: `AiTradingRace.Web/Controllers/AgentsController.cs`**
```csharp
using AiTradingRace.Application.Common.Exceptions;

[HttpGet("{id:guid}")]
public async Task<ActionResult<AgentDto>> GetAgent(Guid id, CancellationToken ct)
{
    var agent = await _dbContext.Agents.FindAsync(new object[] { id }, ct);
    
    if (agent is null)
    {
        throw new NotFoundException("Agent", id.ToString());
    }
    
    return Ok(MapToDto(agent));
}

[HttpPost("{id:guid}/run")]
public async Task<ActionResult<AgentRunResultDto>> RunAgent(Guid id, CancellationToken ct)
{
    var agent = await _dbContext.Agents.FindAsync(new object[] { id }, ct);
    
    if (agent is null)
    {
        throw new NotFoundException("Agent", id.ToString());
    }
    
    if (!agent.IsActive)
    {
        throw new BusinessRuleException("AGENT_INACTIVE", 
            $"Agent '{agent.Name}' is not active and cannot be run.");
    }
    
    try
    {
        var result = await _agentRunner.RunAgentOnceAsync(id, ct);
        return Ok(MapToDto(result));
    }
    catch (HttpRequestException ex)
    {
        throw new ExternalServiceException("LLM Provider", ex.Message, ex);
    }
}
```

### Estimated Effort: 0.5 days

| Task | Hours |
|------|-------|
| Exception types creation | 1 |
| Global handler implementation | 2 |
| Controller updates | 1 |
| Testing | 1 |
| **Total** | **5 hours (â‰ˆ0.5 days)** |

---

## Gap #4: Observability & Monitoring

### Current State

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        âŒ CURRENT STATE (BLIND OPERATIONS)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   .NET API   â”‚     â”‚  ML Service  â”‚     â”‚  React App   â”‚
  â”‚              â”‚     â”‚              â”‚     â”‚              â”‚
  â”‚  Log files   â”‚     â”‚  Log files   â”‚     â”‚  Console     â”‚
  â”‚  (isolated)  â”‚     â”‚  (isolated)  â”‚     â”‚  (isolated)  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚                    â”‚
         â”‚                    â”‚                    â”‚
         â–¼                    â–¼                    â–¼
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘                    ??? BLACK BOX ???                       â•‘
  â•‘                                                            â•‘
  â•‘  â€¢ No request tracing across services                      â•‘
  â•‘  â€¢ No performance metrics                                  â•‘
  â•‘  â€¢ No alerting on failures                                 â•‘
  â•‘  â€¢ No dashboards for visibility                            â•‘
  â•‘                                                            â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### Target State

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        âœ… TARGET STATE (FULL OBSERVABILITY)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   .NET API   â”‚     â”‚  ML Service  â”‚     â”‚  React App   â”‚
  â”‚              â”‚     â”‚              â”‚     â”‚              â”‚
  â”‚ OpenTelemetryâ”‚     â”‚ OpenTelemetryâ”‚     â”‚    Sentry    â”‚
  â”‚   SDK        â”‚     â”‚   SDK        â”‚     â”‚              â”‚
  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚                    â”‚
         â”‚    Traces          â”‚    Traces          â”‚    Errors
         â”‚    Metrics         â”‚    Metrics         â”‚    
         â”‚    Logs            â”‚    Logs            â”‚
         â”‚                    â”‚                    â”‚
         â–¼                    â–¼                    â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                    OBSERVABILITY PLATFORM                               â”‚
  â”‚                                                                         â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
  â”‚  â”‚   Jaeger    â”‚   â”‚ Prometheus  â”‚   â”‚    Loki     â”‚   â”‚   Grafana  â”‚ â”‚
  â”‚  â”‚  (Traces)   â”‚   â”‚  (Metrics)  â”‚   â”‚   (Logs)    â”‚   â”‚(Dashboards)â”‚ â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
  â”‚                                                                         â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
  â”‚  â”‚                    ALERTMANAGER                                 â”‚   â”‚
  â”‚  â”‚  â€¢ Error rate > 5% â†’ PagerDuty                                 â”‚   â”‚
  â”‚  â”‚  â€¢ Latency p99 > 5s â†’ Slack                                    â”‚   â”‚
  â”‚  â”‚  â€¢ Agent failures â†’ Email                                      â”‚   â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
  â”‚                                                                         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Observability Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    THREE PILLARS OF OBSERVABILITY                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘      TRACES       â•‘   â•‘      METRICS      â•‘   â•‘       LOGS        â•‘
  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£   â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£   â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
  â•‘                   â•‘   â•‘                   â•‘   â•‘                   â•‘
  â•‘  Request flow     â•‘   â•‘  Counters:        â•‘   â•‘  Structured:      â•‘
  â•‘  across services  â•‘   â•‘  â€¢ requests_total â•‘   â•‘  â€¢ JSON format    â•‘
  â•‘                   â•‘   â•‘  â€¢ errors_total   â•‘   â•‘  â€¢ Correlation ID â•‘
  â•‘  Span hierarchy:  â•‘   â•‘  â€¢ trades_total   â•‘   â•‘  â€¢ Log levels     â•‘
  â•‘  â”œâ”€ HTTP Request  â•‘   â•‘                   â•‘   â•‘                   â•‘
  â•‘  â”‚  â”œâ”€ DB Query   â•‘   â•‘  Histograms:      â•‘   â•‘  Context:         â•‘
  â•‘  â”‚  â”œâ”€ LLM Call   â•‘   â•‘  â€¢ latency_ms     â•‘   â•‘  â€¢ User ID        â•‘
  â•‘  â”‚  â””â”€ ML Call    â•‘   â•‘  â€¢ trade_value    â•‘   â•‘  â€¢ Agent ID       â•‘
  â•‘  â””â”€ Response      â•‘   â•‘                   â•‘   â•‘  â€¢ Request path   â•‘
  â•‘                   â•‘   â•‘  Gauges:          â•‘   â•‘                   â•‘
  â•‘  Correlation ID   â•‘   â•‘  â€¢ active_agents  â•‘   â•‘  Searchable via   â•‘
  â•‘  links all spans  â•‘   â•‘  â€¢ portfolio_val  â•‘   â•‘  Loki/Grafana     â•‘
  â•‘                   â•‘   â•‘                   â•‘   â•‘                   â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          â”‚                       â”‚                       â”‚
          â”‚                       â”‚                       â”‚
          â–¼                       â–¼                       â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚Jaeger â”‚             â”‚Prometheus â”‚           â”‚  Loki  â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                       â”‚                       â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚   GRAFANA   â”‚
                          â”‚  Dashboard  â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Implementation Plan

#### Phase 1: Add Docker Services

**File: `docker-compose.observability.yml`**
```yaml
version: '3.8'

services:
  # Jaeger - Distributed Tracing
  jaeger:
    image: jaegertracing/all-in-one:1.53
    container_name: ai-trading-jaeger
    ports:
      - "6831:6831/udp"   # Jaeger thrift compact
      - "16686:16686"     # Jaeger UI
      - "4317:4317"       # OTLP gRPC
      - "4318:4318"       # OTLP HTTP
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    networks:
      - ai-trading-network

  # Prometheus - Metrics
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: ai-trading-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./observability/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
    networks:
      - ai-trading-network

  # Grafana - Dashboards
  grafana:
    image: grafana/grafana:10.2.2
    container_name: ai-trading-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin123}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - ./observability/grafana/provisioning:/etc/grafana/provisioning
      - ./observability/grafana/dashboards:/var/lib/grafana/dashboards
      - grafana-data:/var/lib/grafana
    depends_on:
      - prometheus
      - jaeger
    networks:
      - ai-trading-network

  # Loki - Log Aggregation
  loki:
    image: grafana/loki:2.9.2
    container_name: ai-trading-loki
    ports:
      - "3100:3100"
    volumes:
      - ./observability/loki.yml:/etc/loki/local-config.yaml
      - loki-data:/loki
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - ai-trading-network

  # Alertmanager
  alertmanager:
    image: prom/alertmanager:v0.26.0
    container_name: ai-trading-alertmanager
    ports:
      - "9093:9093"
    volumes:
      - ./observability/alertmanager.yml:/etc/alertmanager/alertmanager.yml
    networks:
      - ai-trading-network

volumes:
  prometheus-data:
  grafana-data:
  loki-data:
```

#### Phase 2: Add OpenTelemetry to .NET

**Install packages:**
```bash
dotnet add AiTradingRace.Web package OpenTelemetry.Extensions.Hosting
dotnet add AiTradingRace.Web package OpenTelemetry.Instrumentation.AspNetCore
dotnet add AiTradingRace.Web package OpenTelemetry.Instrumentation.Http
dotnet add AiTradingRace.Web package OpenTelemetry.Instrumentation.EntityFrameworkCore
dotnet add AiTradingRace.Web package OpenTelemetry.Exporter.OpenTelemetryProtocol
dotnet add AiTradingRace.Web package OpenTelemetry.Exporter.Prometheus.AspNetCore
```

**File: `AiTradingRace.Web/Extensions/ObservabilityExtensions.cs`**
```csharp
using System.Diagnostics;
using System.Diagnostics.Metrics;
using OpenTelemetry.Logs;
using OpenTelemetry.Metrics;
using OpenTelemetry.Resources;
using OpenTelemetry.Trace;

namespace AiTradingRace.Web.Extensions;

public static class ObservabilityExtensions
{
    public static readonly string ServiceName = "AiTradingRace.Web";
    public static readonly string ServiceVersion = "1.0.0";
    
    // Custom metrics
    public static readonly Meter Meter = new(ServiceName, ServiceVersion);
    public static readonly Counter<long> AgentRunsCounter = 
        Meter.CreateCounter<long>("agent.runs.total", "runs", "Total agent runs");
    public static readonly Counter<long> TradesExecutedCounter = 
        Meter.CreateCounter<long>("trades.executed.total", "trades", "Total trades executed");
    public static readonly Counter<long> ErrorsCounter = 
        Meter.CreateCounter<long>("errors.total", "errors", "Total errors");
    public static readonly Histogram<double> AgentRunDuration = 
        Meter.CreateHistogram<double>("agent.run.duration_ms", "ms", "Agent run duration");
    public static readonly Histogram<double> TradeValue = 
        Meter.CreateHistogram<double>("trade.value_usd", "USD", "Trade value in USD");

    public static IServiceCollection AddObservability(
        this IServiceCollection services,
        IConfiguration configuration)
    {
        var otlpEndpoint = configuration["OpenTelemetry:OtlpEndpoint"] 
            ?? "http://localhost:4317";

        services.AddOpenTelemetry()
            .ConfigureResource(resource => resource
                .AddService(
                    serviceName: ServiceName,
                    serviceVersion: ServiceVersion)
                .AddAttributes(new Dictionary<string, object>
                {
                    ["environment"] = configuration["ASPNETCORE_ENVIRONMENT"] ?? "Development",
                    ["host.name"] = Environment.MachineName
                }))
            .WithTracing(tracing => tracing
                .AddAspNetCoreInstrumentation(options =>
                {
                    options.RecordException = true;
                    options.Filter = httpContext =>
                    {
                        // Don't trace health checks
                        var path = httpContext.Request.Path.Value;
                        return !path?.Contains("/health") ?? true;
                    };
                })
                .AddHttpClientInstrumentation(options =>
                {
                    options.RecordException = true;
                })
                .AddEntityFrameworkCoreInstrumentation(options =>
                {
                    options.SetDbStatementForText = true;
                })
                .AddSource(ServiceName)
                .AddOtlpExporter(options =>
                {
                    options.Endpoint = new Uri(otlpEndpoint);
                }))
            .WithMetrics(metrics => metrics
                .AddAspNetCoreInstrumentation()
                .AddHttpClientInstrumentation()
                .AddMeter(Meter.Name)
                .AddPrometheusExporter());

        return services;
    }

    public static ILoggingBuilder AddObservabilityLogging(
        this ILoggingBuilder logging,
        IConfiguration configuration)
    {
        var otlpEndpoint = configuration["OpenTelemetry:OtlpEndpoint"] 
            ?? "http://localhost:4317";

        logging.AddOpenTelemetry(options =>
        {
            options.IncludeFormattedMessage = true;
            options.IncludeScopes = true;
            options.ParseStateValues = true;
            options.AddOtlpExporter(exporter =>
            {
                exporter.Endpoint = new Uri(otlpEndpoint);
            });
        });

        return logging;
    }
}
```

#### Phase 3: Instrument Agent Runner

**File: `AiTradingRace.Infrastructure/Agents/AgentRunner.cs`**
```csharp
using System.Diagnostics;
using AiTradingRace.Web.Extensions;

public sealed class AgentRunner : IAgentRunner
{
    private static readonly ActivitySource ActivitySource = 
        new(ObservabilityExtensions.ServiceName);
    
    // ... existing code ...

    public async Task<AgentRunResult> RunAgentOnceAsync(
        Guid agentId,
        CancellationToken cancellationToken = default)
    {
        using var activity = ActivitySource.StartActivity("AgentRun");
        activity?.SetTag("agent.id", agentId.ToString());
        
        var stopwatch = Stopwatch.StartNew();
        
        try
        {
            _logger.LogInformation("Starting agent run for {AgentId}", agentId);
            
            // Step 1: Build context
            using (ActivitySource.StartActivity("BuildContext"))
            {
                context = await _contextBuilder.BuildContextAsync(agentId, 24, cancellationToken);
                activity?.SetTag("agent.name", context.AgentName);
                activity?.SetTag("portfolio.value", context.Portfolio.TotalValue);
            }
            
            // Step 2: Get AI decision
            using (var llmActivity = ActivitySource.StartActivity("GetAIDecision"))
            {
                llmActivity?.SetTag("model.provider", context.ModelProvider.ToString());
                rawDecision = await client.GenerateDecisionAsync(context, cancellationToken);
                llmActivity?.SetTag("orders.count", rawDecision.Orders.Count);
            }
            
            // Step 3: Validate orders
            using (ActivitySource.StartActivity("ValidateOrders"))
            {
                validation = await _riskValidator.ValidateDecisionAsync(
                    rawDecision, context.Portfolio, cancellationToken);
                activity?.SetTag("orders.validated", validation.ValidatedDecision.Orders.Count);
                activity?.SetTag("orders.rejected", validation.RejectedOrders.Count);
            }
            
            // Step 4: Execute trades
            if (validation.ValidatedDecision.Orders.Count > 0)
            {
                using (var tradeActivity = ActivitySource.StartActivity("ExecuteTrades"))
                {
                    portfolio = await _portfolioService.ApplyDecisionAsync(
                        agentId, validation.ValidatedDecision, cancellationToken);
                    
                    // Record trade metrics
                    foreach (var order in validation.ValidatedDecision.Orders)
                    {
                        ObservabilityExtensions.TradesExecutedCounter.Add(1, 
                            new KeyValuePair<string, object?>("agent.id", agentId.ToString()),
                            new KeyValuePair<string, object?>("asset", order.AssetSymbol),
                            new KeyValuePair<string, object?>("side", order.Side.ToString()));
                    }
                }
            }
            
            // Record success
            stopwatch.Stop();
            ObservabilityExtensions.AgentRunsCounter.Add(1,
                new KeyValuePair<string, object?>("agent.id", agentId.ToString()),
                new KeyValuePair<string, object?>("status", "success"));
            ObservabilityExtensions.AgentRunDuration.Record(stopwatch.ElapsedMilliseconds,
                new KeyValuePair<string, object?>("agent.id", agentId.ToString()));
            
            activity?.SetStatus(ActivityStatusCode.Ok);
            
            return new AgentRunResult(Success: true, ...);
        }
        catch (Exception ex)
        {
            stopwatch.Stop();
            
            // Record failure
            ObservabilityExtensions.AgentRunsCounter.Add(1,
                new KeyValuePair<string, object?>("agent.id", agentId.ToString()),
                new KeyValuePair<string, object?>("status", "error"));
            ObservabilityExtensions.ErrorsCounter.Add(1,
                new KeyValuePair<string, object?>("type", ex.GetType().Name));
            
            activity?.SetStatus(ActivityStatusCode.Error, ex.Message);
            activity?.RecordException(ex);
            
            _logger.LogError(ex, "Agent run failed for {AgentId}", agentId);
            throw;
        }
    }
}
```

#### Phase 4: Prometheus Configuration

**File: `observability/prometheus.yml`**
```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093

rule_files:
  - /etc/prometheus/rules/*.yml

scrape_configs:
  # .NET API metrics
  - job_name: 'dotnet-api'
    static_configs:
      - targets: ['host.docker.internal:5000']
    metrics_path: /metrics

  # ML Service metrics
  - job_name: 'ml-service'
    static_configs:
      - targets: ['ml-service:8000']
    metrics_path: /metrics

  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
```

#### Phase 5: Grafana Dashboard

**File: `observability/grafana/dashboards/ai-trading-race.json`**
```json
{
  "dashboard": {
    "title": "AI Trading Race - Operations Dashboard",
    "panels": [
      {
        "title": "Agent Runs (Last 24h)",
        "type": "stat",
        "targets": [
          {
            "expr": "sum(increase(agent_runs_total[24h]))",
            "legendFormat": "Total Runs"
          }
        ]
      },
      {
        "title": "Error Rate",
        "type": "gauge",
        "targets": [
          {
            "expr": "sum(rate(errors_total[5m])) / sum(rate(agent_runs_total[5m])) * 100",
            "legendFormat": "Error %"
          }
        ],
        "thresholds": {
          "steps": [
            { "value": 0, "color": "green" },
            { "value": 5, "color": "yellow" },
            { "value": 10, "color": "red" }
          ]
        }
      },
      {
        "title": "Agent Run Duration (p95)",
        "type": "timeseries",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, sum(rate(agent_run_duration_ms_bucket[5m])) by (le, agent_id))",
            "legendFormat": "{{agent_id}}"
          }
        ]
      },
      {
        "title": "Trades by Asset",
        "type": "piechart",
        "targets": [
          {
            "expr": "sum(trades_executed_total) by (asset)",
            "legendFormat": "{{asset}}"
          }
        ]
      },
      {
        "title": "Request Latency Heatmap",
        "type": "heatmap",
        "targets": [
          {
            "expr": "sum(rate(http_server_duration_bucket[5m])) by (le)"
          }
        ]
      }
    ]
  }
}
```

#### Phase 6: Alert Rules

**File: `observability/prometheus/rules/alerts.yml`**
```yaml
groups:
  - name: ai-trading-race
    interval: 30s
    rules:
      # High error rate
      - alert: HighErrorRate
        expr: |
          sum(rate(errors_total[5m])) / sum(rate(agent_runs_total[5m])) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%)"

      # Slow agent runs
      - alert: SlowAgentRuns
        expr: |
          histogram_quantile(0.95, sum(rate(agent_run_duration_ms_bucket[10m])) by (le)) > 30000
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Agent runs are slow"
          description: "P95 latency is {{ $value | humanizeDuration }} (threshold: 30s)"

      # Service down
      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Service is down"
          description: "{{ $labels.job }} has been down for more than 1 minute"

      # Database connection issues
      - alert: DatabaseConnectionErrors
        expr: |
          increase(db_connection_errors_total[5m]) > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Database connection errors"
          description: "{{ $value }} connection errors in the last 5 minutes"
```

### Estimated Effort: 3-4 days

| Task | Hours |
|------|-------|
| Docker observability stack setup | 4 |
| OpenTelemetry integration (.NET) | 6 |
| OpenTelemetry integration (Python) | 4 |
| Custom metrics & instrumentation | 4 |
| Grafana dashboards | 4 |
| Alert rules configuration | 3 |
| Documentation | 3 |
| **Total** | **28 hours (â‰ˆ3-4 days)** |

---

## Gap #5: Rate Limiting

### Current State vs Target State

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        RATE LIMITING IMPLEMENTATION                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  CURRENT STATE                              TARGET STATE
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  Request â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  API              Request â”€â”€â–º Rate Limiter â”€â”€â–º API
     â”‚                                         â”‚              â”‚
     â”‚  No limits                              â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  âš ï¸ DoS risk                            â”‚     â”‚   Check quota   â”‚
     â–¼                                         â”‚     â”‚                 â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚     â”‚  Quota OK? â”€â”€â”€â”€â”€â”¼â”€â”€â–º Process
  â”‚ Unlimitedâ”‚                                 â”‚     â”‚       â”‚         â”‚
  â”‚ requests â”‚                                 â”‚     â”‚       â–¼         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚     â”‚  Quota exceeded â”‚
                                               â”‚     â”‚       â”‚         â”‚
                                               â”‚     â”‚       â–¼         â”‚
                                               â”‚     â”‚  429 Too Many   â”‚
                                               â”‚     â”‚    Requests     â”‚
                                               â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Rate Limiting Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        RATE LIMIT TIERS                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Tier            â”‚ Limit           â”‚ Window          â”‚ Applies To            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Global          â”‚ 1000 req        â”‚ 1 minute        â”‚ All requests          â”‚
â”‚ Per-IP          â”‚ 100 req         â”‚ 1 minute        â”‚ Anonymous requests    â”‚
â”‚ Per-User        â”‚ 200 req         â”‚ 1 minute        â”‚ Authenticated users   â”‚
â”‚ Agent Run       â”‚ 10 req          â”‚ 1 minute        â”‚ POST /api/agents/run  â”‚
â”‚ Admin Actions   â”‚ 20 req          â”‚ 1 minute        â”‚ POST /api/admin/*     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Implementation Plan

**File: `AiTradingRace.Web/Extensions/RateLimitingExtensions.cs`**
```csharp
using System.Threading.RateLimiting;

namespace AiTradingRace.Web.Extensions;

public static class RateLimitingExtensions
{
    public static IServiceCollection AddApiRateLimiting(this IServiceCollection services)
    {
        services.AddRateLimiter(options =>
        {
            // Global limiter
            options.GlobalLimiter = PartitionedRateLimiter.Create<HttpContext, string>(
                httpContext =>
                    RateLimitPartition.GetFixedWindowLimiter(
                        partitionKey: "global",
                        factory: _ => new FixedWindowRateLimiterOptions
                        {
                            AutoReplenishment = true,
                            PermitLimit = 1000,
                            Window = TimeSpan.FromMinutes(1)
                        }));

            // Per-IP limiter for anonymous requests
            options.AddPolicy("PerIp", httpContext =>
                RateLimitPartition.GetFixedWindowLimiter(
                    partitionKey: httpContext.Connection.RemoteIpAddress?.ToString() ?? "unknown",
                    factory: _ => new FixedWindowRateLimiterOptions
                    {
                        AutoReplenishment = true,
                        PermitLimit = 100,
                        Window = TimeSpan.FromMinutes(1)
                    }));

            // Per-User limiter for authenticated requests
            options.AddPolicy("PerUser", httpContext =>
                RateLimitPartition.GetFixedWindowLimiter(
                    partitionKey: httpContext.User.Identity?.Name ?? "anonymous",
                    factory: _ => new FixedWindowRateLimiterOptions
                    {
                        AutoReplenishment = true,
                        PermitLimit = 200,
                        Window = TimeSpan.FromMinutes(1)
                    }));

            // Strict limiter for agent runs (expensive operation)
            options.AddPolicy("AgentRun", httpContext =>
                RateLimitPartition.GetFixedWindowLimiter(
                    partitionKey: httpContext.User.Identity?.Name ?? 
                        httpContext.Connection.RemoteIpAddress?.ToString() ?? "unknown",
                    factory: _ => new FixedWindowRateLimiterOptions
                    {
                        AutoReplenishment = true,
                        PermitLimit = 10,
                        Window = TimeSpan.FromMinutes(1)
                    }));

            // Admin actions limiter
            options.AddPolicy("AdminActions", httpContext =>
                RateLimitPartition.GetFixedWindowLimiter(
                    partitionKey: httpContext.User.Identity?.Name ?? "admin",
                    factory: _ => new FixedWindowRateLimiterOptions
                    {
                        AutoReplenishment = true,
                        PermitLimit = 20,
                        Window = TimeSpan.FromMinutes(1)
                    }));

            // Handle rejected requests
            options.OnRejected = async (context, cancellationToken) =>
            {
                context.HttpContext.Response.StatusCode = StatusCodes.Status429TooManyRequests;
                context.HttpContext.Response.ContentType = "application/problem+json";

                var retryAfter = context.Lease.TryGetMetadata(
                    MetadataName.RetryAfter, out var retryAfterValue)
                    ? retryAfterValue
                    : TimeSpan.FromSeconds(60);

                context.HttpContext.Response.Headers.RetryAfter = 
                    ((int)retryAfter.TotalSeconds).ToString();

                var problemDetails = new
                {
                    type = "https://api.ai-trading-race.com/errors/rate-limit-exceeded",
                    title = "Rate Limit Exceeded",
                    status = 429,
                    detail = $"Too many requests. Please retry after {retryAfter.TotalSeconds} seconds.",
                    retryAfterSeconds = retryAfter.TotalSeconds
                };

                await context.HttpContext.Response.WriteAsJsonAsync(
                    problemDetails, cancellationToken);
            };
        });

        return services;
    }
}
```

**Update Controllers:**
```csharp
[ApiController]
[Route("api/[controller]")]
[EnableRateLimiting("PerUser")]
public class AgentsController : ControllerBase
{
    [HttpPost("{id:guid}/run")]
    [EnableRateLimiting("AgentRun")]
    public async Task<ActionResult<AgentRunResultDto>> RunAgent(Guid id) { ... }
}

[ApiController]
[Route("api/admin")]
[EnableRateLimiting("AdminActions")]
public class AdminController : ControllerBase { ... }
```

### Estimated Effort: 1 day

| Task | Hours |
|------|-------|
| Rate limiter configuration | 2 |
| Policy definitions | 2 |
| Controller annotations | 1 |
| Testing | 2 |
| Documentation | 1 |
| **Total** | **8 hours (â‰ˆ1 day)** |

---

## Gap #6: Test Coverage

### Current State vs Target State

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        TEST COVERAGE IMPROVEMENT                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  CURRENT STATE                              TARGET STATE
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Unit Tests: ~40%       â”‚               â”‚  Unit Tests: 80%+       â”‚
  â”‚  Integration: Limited   â”‚       â”€â”€â–º     â”‚  Integration: 70%+      â”‚
  â”‚  E2E: None              â”‚               â”‚  E2E: Critical paths    â”‚
  â”‚  Performance: None      â”‚               â”‚  Performance: Baseline  â”‚
  â”‚  Coverage: Unknown      â”‚               â”‚  Coverage: Measured     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Test Pyramid

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            TEST PYRAMID                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                            â•±â•²
                           â•±  â•²
                          â•± E2Eâ•²         5-10 tests
                         â•±â”€â”€â”€â”€â”€â”€â•²        â€¢ Full user flows
                        â•±        â•²       â€¢ Playwright/Cypress
                       â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²
                      â•± Integrationâ•²     30-50 tests
                     â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²    â€¢ API endpoints
                    â•±                â•²   â€¢ Database operations
                   â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²
                  â•±    Unit Tests      â•²  100-200 tests
                 â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•² â€¢ Services
                â•±                        â•²â€¢ Validators
               â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²â€¢ Business logic
```

### Implementation Plan

#### Phase 1: Add Coverlet for Code Coverage

```bash
# Add Coverlet to test project
dotnet add AiTradingRace.Tests package coverlet.collector
dotnet add AiTradingRace.Tests package coverlet.msbuild

# Run tests with coverage
dotnet test --collect:"XPlat Code Coverage" --results-directory ./coverage

# Generate HTML report
dotnet tool install -g dotnet-reportgenerator-globaltool
reportgenerator -reports:"./coverage/**/coverage.cobertura.xml" \
    -targetdir:"./coverage/report" -reporttypes:Html
```

#### Phase 2: Add Missing Unit Tests

**File: `AiTradingRace.Tests/Agents/AgentRunnerTests.cs`**
```csharp
public class AgentRunnerTests
{
    [Fact]
    public async Task RunAgentOnceAsync_WithValidAgent_ReturnsSuccessResult()
    {
        // Arrange
        var agentId = Guid.NewGuid();
        var mockContextBuilder = new Mock<IAgentContextBuilder>();
        var mockRiskValidator = new Mock<IRiskValidator>();
        var mockPortfolioService = new Mock<IPortfolioService>();
        // ... setup mocks ...

        var runner = new AgentRunner(
            mockContextBuilder.Object,
            mockFactory.Object,
            mockRiskValidator.Object,
            mockPortfolioService.Object,
            mockEquityService.Object,
            mockLogger.Object);

        // Act
        var result = await runner.RunAgentOnceAsync(agentId);

        // Assert
        Assert.True(result.Success);
        mockPortfolioService.Verify(x => x.ApplyDecisionAsync(
            agentId, It.IsAny<AgentDecision>(), It.IsAny<CancellationToken>()),
            Times.Once);
    }

    [Fact]
    public async Task RunAgentOnceAsync_WhenLlmFails_ReturnsFailureResult()
    {
        // Test graceful degradation when LLM is unavailable
    }

    [Fact]
    public async Task RunAgentOnceAsync_WithAllOrdersRejected_DoesNotExecuteTrades()
    {
        // Test that rejected orders don't result in trades
    }
}
```

#### Phase 3: Add E2E Tests with Playwright

```bash
# Install Playwright
npm init playwright@latest ai-trading-race-e2e
```

**File: `ai-trading-race-e2e/tests/agent-workflow.spec.ts`**
```typescript
import { test, expect } from '@playwright/test';

test.describe('Agent Trading Workflow', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/');
  });

  test('should display leaderboard', async ({ page }) => {
    await expect(page.locator('h1')).toContainText('Leaderboard');
    await expect(page.locator('.agent-card')).toHaveCount(5);
  });

  test('should show agent details', async ({ page }) => {
    await page.click('.agent-card:first-child');
    await expect(page.locator('.agent-name')).toBeVisible();
    await expect(page.locator('.portfolio-value')).toBeVisible();
    await expect(page.locator('.equity-chart')).toBeVisible();
  });

  test('admin can trigger agent run', async ({ page }) => {
    // Login as admin
    await page.goto('/login');
    await page.fill('#email', 'admin@example.com');
    await page.fill('#password', 'admin123');
    await page.click('button[type="submit"]');

    // Navigate to agent
    await page.goto('/agents/123');
    
    // Trigger run
    await page.click('#run-agent-btn');
    
    // Verify success
    await expect(page.locator('.toast-success')).toContainText('Agent run completed');
  });
});
```

#### Phase 4: Add Performance Tests

**File: `AiTradingRace.Tests/Performance/AgentRunnerBenchmark.cs`**
```csharp
using BenchmarkDotNet.Attributes;
using BenchmarkDotNet.Running;

[MemoryDiagnoser]
[SimpleJob(launchCount: 1, warmupCount: 3, iterationCount: 10)]
public class AgentRunnerBenchmark
{
    private IAgentRunner _agentRunner = null!;
    private Guid _agentId;

    [GlobalSetup]
    public void Setup()
    {
        // Setup in-memory database and services
        var services = new ServiceCollection();
        // ... configure services ...
        
        var provider = services.BuildServiceProvider();
        _agentRunner = provider.GetRequiredService<IAgentRunner>();
        _agentId = /* Create test agent */;
    }

    [Benchmark]
    public async Task RunAgentOnce()
    {
        await _agentRunner.RunAgentOnceAsync(_agentId);
    }

    [Benchmark]
    public async Task RunAgentWithMockLlm()
    {
        // Benchmark with mocked LLM for consistent results
    }
}
```

### Estimated Effort: 3-5 days

| Task | Hours |
|------|-------|
| Coverlet setup & CI integration | 2 |
| Unit tests for AgentRunner | 4 |
| Unit tests for PortfolioService | 4 |
| Unit tests for Controllers | 4 |
| Integration tests for API | 6 |
| E2E tests with Playwright | 8 |
| Performance benchmarks | 4 |
| CI/CD coverage reporting | 2 |
| **Total** | **34 hours (â‰ˆ4-5 days)** |

---

## Implementation Timeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        IMPLEMENTATION TIMELINE (3 WEEKS)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  WEEK 1                    WEEK 2                    WEEK 3
  â”€â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€â”€
  
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Authentication  â”‚      â”‚ Observability   â”‚      â”‚ Test Coverage   â”‚
  â”‚ (3 days)        â”‚      â”‚ (3-4 days)      â”‚      â”‚ (3-5 days)      â”‚
  â”‚                 â”‚      â”‚                 â”‚      â”‚                 â”‚
  â”‚ â€¢ JWT setup     â”‚      â”‚ â€¢ OpenTelemetry â”‚      â”‚ â€¢ Unit tests    â”‚
  â”‚ â€¢ RBAC          â”‚      â”‚ â€¢ Grafana       â”‚      â”‚ â€¢ E2E tests     â”‚
  â”‚ â€¢ React auth    â”‚      â”‚ â€¢ Alerts        â”‚      â”‚ â€¢ Performance   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                        â”‚                        â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
  â”‚ Backup/DR       â”‚      â”‚ Rate Limiting   â”‚               â”‚
  â”‚ (1 day)         â”‚      â”‚ (1 day)         â”‚               â”‚
  â”‚                 â”‚      â”‚                 â”‚               â”‚
  â”‚ â€¢ Backup script â”‚      â”‚ â€¢ ASP.NET limiterâ”‚              â”‚
  â”‚ â€¢ Restore test  â”‚      â”‚ â€¢ Policy config â”‚               â”‚
  â”‚ â€¢ Azure sync    â”‚      â”‚                 â”‚               â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
           â”‚                                                  â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
  â”‚ Exception       â”‚                                        â”‚
  â”‚ Handler         â”‚                                        â”‚
  â”‚ (0.5 days)      â”‚                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
           â”‚                                                  â”‚
           â–¼                                                  â–¼
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                          PRODUCTION READY âœ…
```

### Sprint Breakdown

| Sprint | Focus Area | Days | Deliverables |
|--------|------------|------|--------------|
| **Sprint 1** | Security | 4.5 | Authentication, Backup, Exception Handler |
| **Sprint 2** | Observability | 4-5 | OpenTelemetry, Grafana, Alerting, Rate Limiting |
| **Sprint 3** | Quality | 4-5 | Test Coverage, E2E Tests, Performance Tests |

---

## Resource Requirements

### Team Allocation

| Role | Allocation | Sprints |
|------|------------|---------|
| Backend Developer | 100% | All |
| DevOps Engineer | 50% | Sprint 2 |
| QA Engineer | 100% | Sprint 3 |
| Frontend Developer | 25% | Sprint 1 (Auth) |

### Infrastructure Costs (Monthly)

| Service | Purpose | Estimated Cost |
|---------|---------|----------------|
| Azure Blob Storage | Backup storage (50 GB) | ~$1 |
| Grafana Cloud (Free Tier) | Dashboards & Alerts | $0 |
| Auth0 (Free Tier) | Authentication (7,000 MAU) | $0 |
| **Total** | | **~$1/month** |

### Tools & Licenses

| Tool | Purpose | Cost |
|------|---------|------|
| Playwright | E2E Testing | Free (OSS) |
| Coverlet | Code Coverage | Free (OSS) |
| OpenTelemetry | Observability | Free (OSS) |
| Jaeger | Tracing | Free (OSS) |
| Prometheus | Metrics | Free (OSS) |
| Grafana | Dashboards | Free (OSS) |

---

## Success Criteria

### Definition of Done

Each gap is considered resolved when:

1. **Authentication & Authorization**
   - [ ] All API endpoints require authentication (except public ones)
   - [ ] Role-based access control is enforced
   - [ ] React frontend integrates with auth provider
   - [ ] Unauthorized requests return 401/403

2. **Backup & Disaster Recovery**
   - [ ] Daily full backups run automatically
   - [ ] Backups are synced to Azure Blob
   - [ ] Restore procedure tested successfully
   - [ ] RTO < 1 hour, RPO < 2 hours verified

3. **Global Exception Handling**
   - [ ] All endpoints return RFC 7807 ProblemDetails
   - [ ] Correlation IDs included in responses
   - [ ] Sensitive info hidden in production
   - [ ] Exceptions logged with full context

4. **Observability & Monitoring**
   - [ ] Distributed tracing across all services
   - [ ] Prometheus metrics exposed
   - [ ] Grafana dashboard with key metrics
   - [ ] Alerts configured for critical issues

5. **Rate Limiting**
   - [ ] Global rate limit enforced
   - [ ] Per-user/per-IP limits in place
   - [ ] Agent run endpoint has strict limit
   - [ ] 429 responses include Retry-After header

6. **Test Coverage**
   - [ ] Code coverage â‰¥ 80%
   - [ ] E2E tests for critical paths
   - [ ] Performance benchmarks established
   - [ ] Coverage reports in CI/CD

---

## Conclusion

This remediation plan addresses all critical gaps identified in the architecture audit. By following this plan, the AI Trading Race platform will achieve:

- **Enhanced Security**: JWT authentication + RBAC
- **Data Protection**: Automated backups with disaster recovery
- **Consistent UX**: Unified error handling
- **Operational Visibility**: Full observability stack
- **DoS Protection**: Multi-tier rate limiting
- **Quality Assurance**: Comprehensive test coverage

**Total Estimated Effort**: 11-15 days  
**Recommended Timeline**: 3 weeks (including buffer)  
**Post-Implementation Status**: **Production-Grade** âœ…

---

*Document Version: 1.0*  
*Last Updated: January 20, 2026*
